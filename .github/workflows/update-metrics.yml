name: Update Implementation Metrics

on:
    push:
        branches:
            - main
        paths:
            - "docs/IMPLEMENTATION_PLAN.md"

# Rate limit: only run once per hour to prevent spam
concurrency:
    group: update-metrics
    cancel-in-progress: true

jobs:
    update-metrics:
        runs-on: ubuntu-latest

        # Skip if commit message contains [skip ci] or [skip-metrics]
        if: "!contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[skip-metrics]')"

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  fetch-depth: 1
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies (if needed)
              run: npm ci --only=production || true

            - name: Run metrics update script
              run: node scripts/update-implementation-metrics.mjs

            - name: Check for changes
              id: check_changes
              run: |
                  if git diff --quiet docs/IMPLEMENTATION_PLAN.md; then
                    echo "changed=false" >> $GITHUB_OUTPUT
                  else
                    echo "changed=true" >> $GITHUB_OUTPUT
                  fi

            - name: Commit and push metrics update
              if: steps.check_changes.outputs.changed == 'true'
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"
                  git add docs/IMPLEMENTATION_PLAN.md
                  git commit -m "chore: auto-update implementation metrics [skip ci]"
                  git push
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Comment on commit (optional)
              if: steps.check_changes.outputs.changed == 'true'
              uses: actions/github-script@v7
              with:
                  script: |
                      const sha = context.sha;
                      await github.rest.repos.createCommitComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        commit_sha: sha,
                        body: 'âœ… Implementation metrics auto-updated successfully!'
                      });
