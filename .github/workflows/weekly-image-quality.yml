name: Weekly Image Quality & Optimization

on:
  schedule:
    # Run every Sunday at 3 AM UTC (weekly maintenance)
    - cron: "0 3 * * 0"
  workflow_dispatch:
    inputs:
      mode:
        description: "Operation mode"
        required: true
        default: "audit"
        type: choice
        options:
          - audit
          - audit-gallery
          - download
          - download-force
          - refresh
          - refresh-gallery
          - propose
          - optimize
          - optimize-force
          - full

permissions:
  contents: write
  pull-requests: write

jobs:
  image-quality-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # Note: Sharp (image optimization) is included in dependencies
      # ImageMagick removed - not used by our scripts

      - name: Determine operation mode
        id: mode
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "mode=${{ inputs.mode }}" >> $GITHUB_OUTPUT
          else
            # Weekly schedule: comprehensive audit and fix
            echo "mode=auto" >> $GITHUB_OUTPUT
          fi

      # Enhanced monitoring: Run comprehensive audit
      - name: Comprehensive image audit
        if: steps.mode.outputs.mode == 'audit' || steps.mode.outputs.mode == 'auto' || steps.mode.outputs.mode == 'full'
        id: audit
        continue-on-error: true
        run: |
          echo "## Image Quality Audit Report" > audit-report.md
          echo "" >> audit-report.md
          echo "**Run Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> audit-report.md
          echo "" >> audit-report.md

          # Featured images audit
          echo "### Featured Images" >> audit-report.md
          if npm run images:audit >> audit-report.md 2>&1; then
            echo "audit_failed=false" >> $GITHUB_OUTPUT
          else
            echo "audit_failed=true" >> $GITHUB_OUTPUT
          fi
          echo "" >> audit-report.md

          # Count issues from audit report
          BROKEN=$(grep -c "âŒ" audit-report.md || true)
          PLACEHOLDERS=$(grep -c "âš ï¸.*placeholder" audit-report.md || true)
          TOO_SMALL=$(grep -c "âš ï¸.*too small" audit-report.md || true)

          # Default to 0 if grep found nothing
          BROKEN=${BROKEN:-0}
          PLACEHOLDERS=${PLACEHOLDERS:-0}
          TOO_SMALL=${TOO_SMALL:-0}

          echo "broken_count=$BROKEN" >> $GITHUB_OUTPUT
          echo "placeholder_count=$PLACEHOLDERS" >> $GITHUB_OUTPUT
          echo "too_small_count=$TOO_SMALL" >> $GITHUB_OUTPUT

      - name: Audit gallery images
        if: steps.mode.outputs.mode == 'audit-gallery' || steps.mode.outputs.mode == 'auto' || steps.mode.outputs.mode == 'full'
        id: audit_gallery
        continue-on-error: true
        run: |
          echo "### Gallery Images" >> audit-report.md
          if npm run images:audit:gallery >> audit-report.md 2>&1; then
            echo "gallery_audit_failed=false" >> $GITHUB_OUTPUT
          else
            echo "gallery_audit_failed=true" >> $GITHUB_OUTPUT
          fi
          echo "" >> audit-report.md

      # Generate quality metrics
      - name: Generate quality metrics
        if: steps.mode.outputs.mode == 'auto' || steps.mode.outputs.mode == 'full'
        run: |
          echo "### Quality Metrics" >> audit-report.md
          echo "" >> audit-report.md
          echo "- **Broken/Missing Images:** ${{ steps.audit.outputs.broken_count || 0 }}" >> audit-report.md
          echo "- **Placeholder Images:** ${{ steps.audit.outputs.placeholder_count || 0 }}" >> audit-report.md
          echo "- **Undersized Images:** ${{ steps.audit.outputs.too_small_count || 0 }}" >> audit-report.md

          # Count optimization status
          TOTAL_IMAGES=$(find public/images/trees -maxdepth 1 -name "*.jpg" | wc -l)
          OPTIMIZED_IMAGES=$(find public/images/trees/optimized -maxdepth 1 -type d | wc -l)
          PENDING_IMAGES=$((TOTAL_IMAGES - OPTIMIZED_IMAGES))
          echo "- **Total Tree Images:** $TOTAL_IMAGES" >> audit-report.md
          echo "- **Optimized Images:** $OPTIMIZED_IMAGES" >> audit-report.md
          echo "- **Pending Optimization:** $PENDING_IMAGES" >> audit-report.md

          echo "" >> audit-report.md

          TOTAL_ISSUES=$((${{ steps.audit.outputs.broken_count || 0 }} + ${{ steps.audit.outputs.placeholder_count || 0 }} + ${{ steps.audit.outputs.too_small_count || 0 }}))
          if [ $TOTAL_ISSUES -gt 0 ]; then
            echo "**Status:** âš ï¸ Issues detected - proposals will be generated for admin review" >> audit-report.md
          elif [ $PENDING_IMAGES -gt 0 ]; then
            echo "**Status:** âš ï¸ $PENDING_IMAGES images need optimization" >> audit-report.md
          else
            echo "**Status:** âœ… All images are valid and optimized" >> audit-report.md
          fi

      - name: Download missing/broken images
        if: steps.mode.outputs.mode == 'download'
        run: |
          echo "" >> audit-report.md
          echo "### Automated Fixes Applied" >> audit-report.md
          echo "" >> audit-report.md
          echo "#### Downloaded Missing/Broken Images" >> audit-report.md
          npm run images:download >> audit-report.md 2>&1

      - name: Force download all images
        if: steps.mode.outputs.mode == 'download-force'
        run: npm run images:download:force

      - name: Check for better featured images
        if: steps.mode.outputs.mode == 'refresh'
        run: |
          echo "" >> audit-report.md
          echo "#### Refreshed Featured Images" >> audit-report.md
          npm run images:refresh >> audit-report.md 2>&1

      - name: Refresh gallery images
        if: steps.mode.outputs.mode == 'refresh-gallery'
        run: |
          echo "" >> audit-report.md
          echo "#### Refreshed Gallery Images" >> audit-report.md
          npm run images:refresh:gallery >> audit-report.md 2>&1

      # NEW: Image Optimization Steps

      - name: Generate image review proposals
        if: steps.mode.outputs.mode == 'propose' || steps.mode.outputs.mode == 'auto' || steps.mode.outputs.mode == 'full'
        env:
          API_BASE_URL: ${{ secrets.IMAGE_PROPOSALS_API_BASE_URL }}
          WORKFLOW_TOKEN: ${{ secrets.IMAGE_PROPOSALS_WORKFLOW_TOKEN }}
        run: |
          echo "" >> audit-report.md
          echo "### Image Proposal Generation" >> audit-report.md
          if [ -z "$API_BASE_URL" ]; then
            echo "âš ï¸ Skipped: IMAGE_PROPOSALS_API_BASE_URL secret is not configured." >> audit-report.md
            echo "Set it to your deployed endpoint, e.g. https://example.com/api/admin/images/proposals" >> audit-report.md
          else
            npm run images:propose -- --verbose >> audit-report.md 2>&1
          fi

      - name: Optimize tree images
        if: steps.mode.outputs.mode == 'optimize' || steps.mode.outputs.mode == 'full' || steps.mode.outputs.mode == 'auto'
        run: |
          echo "" >> audit-report.md
          echo "#### Image Optimization" >> audit-report.md
          echo "" >> audit-report.md
          echo "Optimizing tree images (generating WebP, AVIF, responsive sizes)..." >> audit-report.md
          npm run images:optimize >> audit-report.md 2>&1

          # Report optimization results
          OPTIMIZED=$(find public/images/trees/optimized -maxdepth 1 -type d | wc -l)
          echo "" >> audit-report.md
          echo "âœ… Total optimized: $OPTIMIZED trees" >> audit-report.md

      - name: Force re-optimize all images
        if: steps.mode.outputs.mode == 'optimize-force'
        run: |
          echo "" >> audit-report.md
          echo "#### Force Re-optimization" >> audit-report.md
          echo "" >> audit-report.md
          echo "Re-optimizing ALL images..." >> audit-report.md
          npm run images:optimize:force >> audit-report.md 2>&1

      - name: Optimize hero images
        if: steps.mode.outputs.mode == 'full'
        run: |
          echo "" >> audit-report.md
          echo "#### Hero Image Optimization" >> audit-report.md
          npm run images:optimize:hero >> audit-report.md 2>&1

      - name: Run legacy cleanup
        if: steps.mode.outputs.mode == 'full'
        run: |
          echo "" >> audit-report.md
          echo "#### Updated iNaturalist Links" >> audit-report.md
          npm run images:cleanup:force >> audit-report.md 2>&1

      - name: Check for changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT

            # Count changed files
            CHANGED_COUNT=$(git status --porcelain | wc -l)
            echo "changed_count=$CHANGED_COUNT" >> $GITHUB_OUTPUT

            # List changed files
            echo "" >> audit-report.md
            echo "### Files Modified" >> audit-report.md
            echo "" >> audit-report.md
            echo '```' >> audit-report.md
            git status --porcelain >> audit-report.md
            echo '```' >> audit-report.md
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "" >> audit-report.md
            echo "### Result" >> audit-report.md
            echo "" >> audit-report.md
            echo "No changes needed - all images are in good condition! âœ…" >> audit-report.md
          fi

      # Create a pull request instead of auto-pushing
      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: weekly image quality and optimization"
          branch: automated/image-quality-${{ github.run_number }}
          delete-branch: true
          title: "ðŸ–¼ï¸ Weekly Image Quality & Optimization (${{ steps.changes.outputs.changed_count }} files)"
          body-path: audit-report.md
          labels: |
            maintenance
            images
            optimization
            automated
          assignees: sandgraal
          reviewers: sandgraal

      # Post summary even if no changes
      - name: Post workflow summary
        if: always()
        run: |
          if [ -f audit-report.md ]; then
            cat audit-report.md >> $GITHUB_STEP_SUMMARY
          else
            echo "## Image Quality Check" >> $GITHUB_STEP_SUMMARY
            echo "Workflow completed successfully." >> $GITHUB_STEP_SUMMARY
          fi
