# Image Review & Approval System

> **Status**: âœ… Implemented (Code complete, validation pending database deployment)
> **Created**: January 2026
> **Completed**: February 2026  
> **Goal**: Prevent automatic overwrites, enable quality assessment, integrate admin approval workflow

## Problem Statement

### Current Issues

1. **Automated workflows overwrite images** - No human review before changes
2. **Mismatched descriptions** - "Leaf" photo shows whole tree (and vice versa)
3. **No quality assessment** - Can't compare proposed vs current images
4. **localStorage voting** - Votes stored client-side, never processed
5. **No approval workflow** - Changes apply immediately or not at all
6. **No audit trail** - Can't track who approved what and when

### User Story

> "As an admin, I want workflow runs to **propose** image changes so I can review them before they replace existing good images. I also want crowdsourced feedback from users to help identify the best images."

## Proposed Architecture

### Three-Layer System

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. WORKFLOW LAYER (Propose Changes)                         â”‚
â”‚    - Weekly workflow finds better images                     â”‚
â”‚    - Creates proposals in database                           â”‚
â”‚    - NEVER auto-applies changes                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. REVIEW LAYER (Admin Approval)                            â”‚
â”‚    - Admin dashboard shows proposals                         â”‚
â”‚    - Side-by-side comparison (current vs proposed)          â”‚
â”‚    - Approve/Deny/Archive actions                           â”‚
â”‚    - Quality assessment criteria                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. CROWDSOURCE LAYER (User Voting)                          â”‚
â”‚    - Public voting page (no login required)                 â”‚
â”‚    - Flag mislabeled images (leaf vs tree mismatch)         â”‚
â”‚    - Upvote/downvote image quality                          â”‚
â”‚    - Feeds into admin review dashboard                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Database Schema

### New Tables

```prisma
// Image change proposal from automated workflows
model ImageProposal {
  id              String   @id @default(cuid())
  treeSlug        String
  imageType       String   // "featured", "gallery-leaf", "gallery-bark", etc.

  // Current state
  currentUrl      String?
  currentSource   String?  // "local", "inaturalist", "unsplash", etc.

  // Proposed state
  proposedUrl     String
  proposedSource  String
  proposedReason  String   // "higher_resolution", "better_quality", "correct_subject", etc.

  // Quality metrics (auto-generated by workflow)
  currentWidth    Int?
  currentHeight   Int?
  proposedWidth   Int
  proposedHeight  Int
  qualityScore    Float?   // 0-100 from image analysis

  // Metadata
  proposedBy      String   // "workflow", "user_suggestion"
  proposedAt      DateTime @default(now())
  workflowRun     String?  // GitHub Actions run ID

  // Review status
  status          String   @default("pending") // "pending", "approved", "denied", "archived"
  reviewedBy      String?  // User ID
  reviewedAt      DateTime?
  reviewNotes     String?

  // Applied status
  appliedAt       DateTime?

  @@index([treeSlug, imageType])
  @@index([status])
  @@index([proposedAt])
  @@map("image_proposals")
}

// User votes on image quality (crowdsourced)
model ImageVote {
  id              String   @id @default(cuid())
  treeSlug        String
  imageUrl        String
  imageType       String   // "featured", "gallery-leaf", etc.

  // Vote data
  voteType        String   // "upvote", "downvote", "flag_mismatch"
  flagReason      String?  // For flags: "wrong_subject", "low_quality", "mislabeled", etc.
  flagDetails     String?  // User description of issue

  // Voter info (anonymous allowed)
  voterIp         String?  @db.VarChar(45)
  voterSession    String?  // Session ID for anonymous voters
  userId          String?  // If logged in

  // Metadata
  createdAt       DateTime @default(now())
  processed       Boolean  @default(false)

  @@index([treeSlug, imageUrl])
  @@index([voteType])
  @@index([processed])
  @@map("image_votes")
}

// Audit trail for all image changes
model ImageAudit {
  id              String   @id @default(cuid())
  treeSlug        String
  imageType       String

  // Change details
  action          String   // "added", "replaced", "removed", "rejected_proposal"
  oldUrl          String?
  newUrl          String?
  source          String?  // "workflow", "manual_upload", "proposal_approval"

  // Who and when
  userId          String?
  userName        String?
  performedAt     DateTime @default(now())

  // Context
  proposalId      String?  // Link to ImageProposal if from approval
  notes           String?

  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([treeSlug])
  @@index([performedAt])
  @@map("image_audits")
}
```

### Schema Updates

```prisma
// Add to User model
model User {
  // ... existing fields ...
  imageAudits   ImageAudit[]
}
```

## Workflow Changes

### Updated Weekly Workflow

```yaml
# .github/workflows/weekly-image-quality.yml

# NEW: Proposal Generation (replaces auto-apply)
- name: Generate image proposals
  run: |
    echo "### Image Change Proposals" >> audit-report.md

    # Find better images and create proposals (don't apply)
    npm run images:propose:refresh >> audit-report.md 2>&1

    # Proposals are saved to database, not applied

- name: Create or Update Image Proposals PR
  uses: peter-evans/create-pull-request@v8
  with:
    title: "ðŸ“‹ Image Proposals - Review Required"
    body: |
      ## Image Change Proposals Generated

      **Action Required**: Visit admin dashboard to review proposals

      ðŸ”— [Review Proposals](/admin/images/proposals)

      This PR contains **proposal data only** - no images changed yet.
      Images will update only after admin approval.
```

### New Script: `propose-image-changes.mjs`

```javascript
/**
 * Generate image proposals without applying changes
 * Saves proposals to database for admin review
 */

// Find better images from iNaturalist
const betterImages = await findBetterQualityImages(treeSlug);

for (const proposed of betterImages) {
  const current = getCurrentImage(treeSlug);

  // Calculate quality metrics
  const qualityScore = await analyzeImageQuality(proposed.url);

  // Create proposal
  await prisma.imageProposal.create({
    data: {
      treeSlug,
      imageType: "featured",
      currentUrl: current.url,
      proposedUrl: proposed.url,
      proposedReason: proposed.reason,
      qualityScore,
      proposedBy: "workflow",
      workflowRun: process.env.GITHUB_RUN_ID,
    },
  });
}
```

## Admin Dashboard

### Page: `/admin/images/proposals`

**Features**:

1. **Proposal Queue**
   - List all pending proposals
   - Sort by: date, quality score, tree name
   - Filter by: image type, reason, tree

2. **Side-by-Side Comparison**

   ```
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   Current Image     â”‚   Proposed Image    â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ 800Ã—600 (low res)   â”‚ 1920Ã—1440 (hi res) â”‚
   â”‚ Source: iNaturalist â”‚ Source: iNaturalist â”‚
   â”‚ Added: 2025-06-15   â”‚ Found: 2026-01-19  â”‚
   â”‚                     â”‚                     â”‚
   â”‚ User Votes: 3â†‘ 1â†“   â”‚ Quality: 87/100    â”‚
   â”‚ Flags: 2 mismatch   â”‚ Reason: Higher res  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   [ðŸ—‘ï¸ Archive]  [âŒ Deny]  [âœ… Approve & Apply]
   ```

3. **Quality Criteria Checklist**
   - [ ] Image resolution adequate (min 800px)
   - [ ] Subject matches description (leaf shows leaves)
   - [ ] Good lighting and focus
   - [ ] Species clearly identifiable
   - [ ] Proper attribution available
   - [ ] Better than current image

4. **Batch Actions**
   - Approve all high-quality (score >80)
   - Deny all low-quality (score <50)
   - Archive outdated proposals

5. **Integration with Votes**
   - Show user vote count next to proposals
   - Highlight flagged images
   - Display flag reasons

### Implementation

```tsx
// src/app/[locale]/admin/images/proposals/page.tsx

export default async function ProposalsPage() {
  const proposals = await prisma.imageProposal.findMany({
    where: { status: "pending" },
    include: {
      _count: {
        select: {
          votes: true,
          flags: true,
        },
      },
    },
    orderBy: { proposedAt: "desc" },
  });

  return (
    <ProposalReviewDashboard
      proposals={proposals}
      onApprove={handleApprove}
      onDeny={handleDeny}
    />
  );
}

async function handleApprove(proposalId: string) {
  // 1. Download proposed image
  await downloadImage(proposal.proposedUrl, localPath);

  // 2. Update MDX frontmatter
  await updateTreeFrontmatter(proposal.treeSlug, {
    featuredImage: localPath,
  });

  // 3. Mark proposal as approved
  await prisma.imageProposal.update({
    where: { id: proposalId },
    data: {
      status: "approved",
      appliedAt: new Date(),
    },
  });

  // 4. Create audit entry
  await prisma.imageAudit.create({
    data: {
      treeSlug: proposal.treeSlug,
      action: "replaced",
      oldUrl: proposal.currentUrl,
      newUrl: proposal.proposedUrl,
      source: "proposal_approval",
      proposalId,
    },
  });

  // 5. Trigger optimization
  await optimizeImage(localPath);
}
```

## Public Voting Page

### Page: `/images/vote`

**Public-facing page for crowdsourcing quality feedback**

**Features**:

1. **Browse Mode**
   - Show random tree images
   - Simple upvote/downvote buttons
   - "Flag as mislabeled" button

2. **Flag Dialog**

   ```
   ðŸš© What's wrong with this image?

   â—‹ Wrong subject (says "leaf" but shows whole tree)
   â—‹ Poor quality (blurry, dark, unclear)
   â—‹ Wrong species (doesn't match description)
   â—‹ Other: [text input]

   [Cancel]  [Submit Flag]
   ```

3. **Leaderboard** (optional gamification)
   - Top contributors this month
   - Most helpful flags
   - Badges for participation

4. **Anonymous Voting**
   - No login required
   - Session-based rate limiting
   - IP + fingerprint tracking for abuse prevention

### Implementation

```tsx
// src/app/[locale]/images/vote/page.tsx

export default function ImageVotingPage() {
  return (
    <div>
      <h1>Help Improve Tree Images</h1>
      <p>Vote on image quality and flag mismatched descriptions</p>

      <ImageVotingCard onVote={handleVote} onFlag={handleFlag} />
    </div>
  );
}

async function handleVote(treeSlug: string, voteType: "up" | "down") {
  await prisma.imageVote.create({
    data: {
      treeSlug,
      imageUrl: currentImage.url,
      imageType: "featured",
      voteType: voteType === "up" ? "upvote" : "downvote",
      voterSession: getSessionId(),
      voterIp: getIpAddress(),
    },
  });
}

async function handleFlag(treeSlug: string, reason: string, details: string) {
  await prisma.imageVote.create({
    data: {
      treeSlug,
      imageUrl: currentImage.url,
      imageType: "featured",
      voteType: "flag_mismatch",
      flagReason: reason,
      flagDetails: details,
      voterSession: getSessionId(),
    },
  });

  // Auto-create proposal to find replacement
  await createProposalForFlaggedImage(treeSlug);
}
```

## Migration Path

### Phase 1: Database Setup (Week 1)

1. Add new tables to schema
2. Run migrations
3. Seed initial proposals from current issues

### Phase 2: Workflow Updates (Week 2)

1. Update weekly workflow to generate proposals (not apply)
2. Create `propose-image-changes.mjs` script
3. Test proposal generation

### Phase 3: Admin Dashboard (Week 3-4)

1. Create proposals review page
2. Implement side-by-side comparison UI
3. Add approve/deny/archive actions
4. Connect to database

### Phase 4: Public Voting (Week 5)

1. Create public voting page
2. Implement anonymous voting
3. Add flag functionality
4. Create leaderboard

### Phase 5: Integration (Week 6)

1. Connect votes to admin dashboard
2. Add automated proposal creation from flags
3. Implement quality scoring
4. Documentation and training

## Configuration

### Quality Thresholds

```typescript
// config/image-quality.ts

export const QUALITY_CONFIG = {
  // Auto-approve if score exceeds threshold AND no flags
  autoApproveThreshold: 90,

  // Auto-deny if score below threshold
  autoDenyThreshold: 40,

  // Minimum resolution (width in pixels)
  minWidth: 800,
  minHeight: 600,

  // Vote thresholds
  flagThreshold: 3, // Auto-create proposal if 3+ flags
  upvoteWeight: 1.0,
  downvoteWeight: -1.5,
  flagWeight: -3.0,

  // Age thresholds
  staleProposalDays: 30, // Archive if not reviewed in 30 days
};
```

## Benefits

### For Admins

âœ… **Control** - Review before changes apply
âœ… **Context** - See why change is proposed
âœ… **Comparison** - Side-by-side current vs proposed
âœ… **Audit trail** - Track all changes
âœ… **Batch operations** - Handle multiple proposals efficiently

### For Users

âœ… **Participation** - Help improve image quality
âœ… **Feedback** - Flag mismatched descriptions
âœ… **Transparency** - See what images are being considered
âœ… **Recognition** - Leaderboard for contributors

### For System

âœ… **Safety** - No automatic overwrites
âœ… **Quality** - Human review catches issues
âœ… **Scalability** - Crowdsourced quality control
âœ… **Compliance** - Full audit trail
âœ… **Flexibility** - Easy to adjust quality criteria

## Next Steps

1. **Review this proposal** - Discuss with team
2. **Prioritize features** - What's MVP vs nice-to-have?
3. **Create implementation tickets** - Break down into tasks
4. **Set timeline** - Realistic 6-week rollout?
5. **Database migration** - Add tables to schema
6. **Start with workflow** - Generate proposals first

## Questions to Resolve

- [ ] Who has admin access to approve proposals?
- [ ] Should we auto-approve high-quality proposals (score >90)?
- [ ] How long should proposals stay pending before archiving?
- [ ] Should user votes be public or anonymous?
- [ ] Do we want email notifications for new proposals?
- [ ] Should we have categories of users (admin, moderator, contributor)?
