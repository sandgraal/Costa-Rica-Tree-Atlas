// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User model for admin authentication
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  passwordHash  String // Argon2id hash
  emailVerified DateTime?
  mfaEnabled    Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sessions   Session[]
  auditLogs  AuditLog[]
  mfaSecrets MFASecret[]

  @@map("users")
}

// Session model for NextAuth
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  ipAddress    String?  @db.VarChar(45) // IPv6 max length
  userAgent    String?  @db.Text
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expires])
  @@map("sessions")
}

// MFA secrets (TOTP and backup codes)
model MFASecret {
  id              String   @id @default(cuid())
  userId          String
  totpSecret      String?  @db.Text // Encrypted TOTP secret
  backupCodes     String[] // Hashed backup codes
  backupCodesUsed Int[]    @default([]) // Indices of used backup codes
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@map("mfa_secrets")
}

// Audit log for security events
model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  eventType String   @db.VarChar(100) // "login", "logout", "login_failed", "mfa_enabled", "mfa_disabled", "password_changed", etc.
  ipAddress String?  @db.VarChar(45)
  userAgent String?  @db.Text
  metadata  Json? // Additional event-specific data
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([eventType])
  @@index([createdAt])
  @@map("audit_logs")
}

// NextAuth Account model (for future OAuth support)
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// NextAuth VerificationToken model (for email verification)
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================================================
// IMAGE REVIEW SYSTEM
// Human-in-the-loop workflow for image quality control
// See docs/IMAGE_REVIEW_SYSTEM.md for full documentation
// ============================================================================

// Proposal statuses for image changes
enum ImageProposalStatus {
  PENDING // Awaiting admin review
  APPROVED // Approved, ready to apply
  APPLIED // Applied to the tree
  DENIED // Rejected by admin
  ARCHIVED // Dismissed/expired
}

// Source of the proposal
enum ImageProposalSource {
  WORKFLOW // From weekly-image-quality workflow
  USER_FLAG // From user flagging an image
  ADMIN // Manually created by admin
  SCRIPT // From ad-hoc scripts
}

// Types of images in the tree gallery
enum ImageType {
  FEATURED // Main hero image
  TREE // Full tree view
  BARK // Bark close-up
  LEAVES // Leaves/foliage
  FLOWERS // Flowers/blooms
  FRUIT // Fruit/seeds
  ROOTS // Root system
  HABITAT // Tree in its habitat/environment
}

// Image proposal for review
model ImageProposal {
  id        String    @id @default(cuid())
  treeSlug  String    @db.VarChar(100)
  imageType ImageType

  // Current image details
  currentUrl    String? @db.Text
  currentSource String? @db.VarChar(255)
  currentAlt    String? @db.Text

  // Proposed image details
  proposedUrl    String  @db.Text
  proposedSource String? @db.VarChar(255)
  proposedAlt    String? @db.Text

  // Quality metrics
  qualityScore Float? // 0-100 quality score
  resolution   String? @db.VarChar(20) // e.g., "1920x1080"
  fileSize     Int? // bytes

  // Workflow/source info
  source        ImageProposalSource
  reason        String?             @db.Text // Why this change is proposed
  workflowRunId String?             @db.VarChar(100) // GitHub Actions run ID

  // Status and review
  status      ImageProposalStatus @default(PENDING)
  reviewedBy  String? // User ID who reviewed
  reviewedAt  DateTime?
  reviewNotes String?             @db.Text

  // Voting aggregates (denormalized for performance)
  upvotes   Int @default(0)
  downvotes Int @default(0)
  flagCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  votes        ImageVote[]
  auditEntries ImageAudit[]

  @@index([treeSlug])
  @@index([status])
  @@index([source])
  @@index([createdAt])
  @@map("image_proposals")
}

// Reasons for flagging an image
enum ImageFlagReason {
  MISLABELED // Image doesn't match the type (leaf shows tree, etc.)
  WRONG_SPECIES // Image shows a different species
  POOR_QUALITY // Blurry, low resolution, bad lighting
  INAPPROPRIATE // Offensive or irrelevant content
  COPYRIGHT // Potential copyright violation
  OTHER // Other reason (see notes)
}

// User votes and flags on images
model ImageVote {
  id         String    @id @default(cuid())
  proposalId String? // Vote on a proposal
  treeSlug   String    @db.VarChar(100) // Can vote on existing images too
  imageType  ImageType

  // Vote type
  isUpvote   Boolean? // true=upvote, false=downvote, null=flag only
  isFlag     Boolean          @default(false)
  flagReason ImageFlagReason?
  flagNotes  String?          @db.Text

  // Voter info (anonymous but trackable)
  sessionId String  @db.VarChar(64) // Anonymous session hash
  ipHash    String? @db.VarChar(64) // Hashed IP for rate limiting
  userId    String? // If logged in (optional)

  createdAt DateTime @default(now())

  // Relations
  proposal ImageProposal? @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  // Prevent duplicate votes per session
  @@unique([proposalId, sessionId])
  @@unique([treeSlug, imageType, sessionId])
  @@index([proposalId])
  @@index([treeSlug, imageType])
  @@index([sessionId])
  @@map("image_votes")
}

// Audit types for image changes
enum ImageAuditAction {
  PROPOSAL_CREATED // New proposal submitted
  PROPOSAL_APPROVED // Admin approved the proposal
  PROPOSAL_DENIED // Admin denied the proposal
  PROPOSAL_APPLIED // Approved proposal was applied
  PROPOSAL_ARCHIVED // Proposal was archived/expired
  IMAGE_REPLACED // Image file was replaced
  IMAGE_DELETED // Image was removed
  VOTE_CAST // User voted on image
  FLAG_SUBMITTED // User flagged an image
}

// Audit log for all image-related changes
model ImageAudit {
  id         String     @id @default(cuid())
  proposalId String?
  treeSlug   String     @db.VarChar(100)
  imageType  ImageType?

  action ImageAuditAction

  // Who performed the action
  actorId      String? // User ID if authenticated
  actorSession String? @db.VarChar(64) // Session ID if anonymous
  ipAddress    String? @db.VarChar(45)

  // What changed
  previousValue String? @db.Text // JSON of previous state
  newValue      String? @db.Text // JSON of new state
  notes         String? @db.Text

  createdAt DateTime @default(now())

  // Relations
  proposal ImageProposal? @relation(fields: [proposalId], references: [id], onDelete: SetNull)

  @@index([proposalId])
  @@index([treeSlug])
  @@index([action])
  @@index([createdAt])
  @@map("image_audits")
}

// ============================================================================
// COMMUNITY CONTRIBUTIONS SYSTEM
// Allow users to suggest new species, corrections, and share local knowledge
// ============================================================================

// Types of community contributions
enum ContributionType {
  NEW_SPECIES // Suggest a new tree species to add
  CORRECTION // Suggest correction to existing content
  LOCAL_KNOWLEDGE // Share traditional/local knowledge
  TRANSLATION // Suggest translation improvement
}

// Status of a contribution
enum ContributionStatus {
  PENDING // Awaiting review
  UNDER_REVIEW // Being reviewed by moderator
  APPROVED // Approved, pending implementation
  IMPLEMENTED // Changes applied to content
  REJECTED // Rejected by moderator
  DUPLICATE // Already exists or submitted
}

// Priority levels for contributions
enum ContributionPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Community contribution submission
model Contribution {
  id   String           @id @default(cuid())
  type ContributionType

  // For NEW_SPECIES: proposed tree details
  // For CORRECTION: target tree and field
  // For LOCAL_KNOWLEDGE: target tree and knowledge type
  treeSlug    String? @db.VarChar(100) // null for new species
  targetField String? @db.VarChar(100) // e.g., "description", "uses", "distribution"

  // Contribution content
  title       String  @db.VarChar(255)
  description String  @db.Text // Main content/details
  evidence    String? @db.Text // Sources, references, personal experience

  // For NEW_SPECIES type
  scientificName String? @db.VarChar(255)
  commonNameEn   String? @db.VarChar(255)
  commonNameEs   String? @db.VarChar(255)
  family         String? @db.VarChar(100)
  proposedImages String[] // URLs or file paths

  // Contributor info (can be anonymous)
  contributorName  String? @db.VarChar(255)
  contributorEmail String? @db.VarChar(255)
  sessionId        String  @db.VarChar(64) // Anonymous session hash
  ipHash           String? @db.VarChar(64) // Hashed IP for rate limiting
  userId           String? // If logged in

  // Review workflow
  status       ContributionStatus   @default(PENDING)
  priority     ContributionPriority @default(MEDIUM)
  reviewedBy   String? // Admin/moderator user ID
  reviewedAt   DateTime?
  reviewNotes  String?              @db.Text
  resolvedPrId String?              @db.VarChar(100) // GitHub PR that implemented this

  // Metadata
  locale    String   @default("en") @db.VarChar(5)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([treeSlug])
  @@index([sessionId])
  @@index([createdAt])
  @@map("contributions")
}
